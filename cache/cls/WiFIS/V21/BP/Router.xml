<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25">
<Class name="WiFIS.V21.BP.Router">
<Description>
</Description>
<ClassType>persistent</ClassType>
<ProcedureBlock>1</ProcedureBlock>
<Super>Ens.BusinessProcessBPL</Super>
<TimeCreated>62251,61236.78099</TimeCreated>

<XData name="BPL">
<Description>
BPL Definition</Description>
<XMLNamespace>http://www.intersystems.com/bpl</XMLNamespace>
<Data><![CDATA[
<process language='objectscript' request='WiFIS.V21.Msg.GenericReq' response='WiFIS.V21.BS.s1.WSResposta' height='2000' width='2000' >
<context>
<property name='BOResponse' type='WiFIS.V21.WSC.s1.WSResposta' initialexpression='##class(WiFIS.V21.WSC.s1.WSResposta).%New()' instantiate='0' >
</property>
<property name='TargetConfigName' type='%String' instantiate='0' >
</property>
<property name='BORequest' type='WiFIS.V21.Msg.GenericReq' instantiate='0' >
</property>
</context>
<sequence xend='200' yend='1650' >
<scope name='scope5' xpos='200' ypos='250' xend='200' yend='1550' >
<code name='Inicializar BORequest' xpos='200' ypos='350' >
<![CDATA[ set context.BORequest=request]]]]><![CDATA[>
</code>
<code name='Calcular Destino' xpos='200' ypos='450' >
<annotation><![CDATA[Calcular componente de la producción al que enviar el mensaje.]]]]><![CDATA[></annotation>
<![CDATA[ set context.TargetConfigName="WiFIS_"_request.Servicio_"_BO_V21"]]]]><![CDATA[>
</code>
<if name='Destino Fijo?' condition='..%Process.TargetConfigName&apos;=""' xpos='200' ypos='550' xend='200' yend='800' >
<annotation><![CDATA[TargetConfigName configurado para
enviar todos mensajes a un destino?]]]]><![CDATA[></annotation>
<true>
<assign name="Establecer Destino Fijo" property="context.TargetConfigName" value="..%Process.TargetConfigName" action="set" xpos='470' ypos='700' />
</true>
<false>
<code name='Buscar URL tabla centros' xpos='200' ypos='700' >
<annotation><![CDATA[Comprobar si el destino tiene URL
configurada en tabla centros.]]]]><![CDATA[></annotation>
<![CDATA[ set tSC=##class(WiFIS.Config.Centro).ObtenerURL(request.Destino,request.Servicio,.url)
 $$$ThrowOnError(tSC)
 
 set context.BORequest.URL = url
 ]]]]><![CDATA[>
</code>
</false>
</if>
<trace name='Mostrar Destino' value='"TargetConfigName="_context.TargetConfigName' xpos='200' ypos='900' />
<trace name='Mostrar URL' value='"URL="_context.BORequest.URL' xpos='200' ypos='1000' />
<call name='Enviar WiFIS' target='@context.TargetConfigName' async='1' xpos='200' ypos='1100' >
<annotation><![CDATA[Enviar a BO WiFIS (TargetConfigName)]]]]><![CDATA[></annotation>
<request type='WiFIS.V21.Msg.GenericReq' >
<assign property="callrequest.URL" value="context.BORequest.URL" action="set" />
<assign property="callrequest.DatosXML" value="context.BORequest.DatosXML" action="set" />
<assign property="callrequest.Destino" value="context.BORequest.Destino" action="set" />
<assign property="callrequest.Origen" value="context.BORequest.Origen" action="set" />
<assign property="callrequest.Servicio" value="context.BORequest.Servicio" action="set" />
<assign property="callrequest.Tipo" value="context.BORequest.Tipo" action="set" />
</request>
<response type='WiFIS.V21.WSC.s1.WSResposta' >
<assign property="context.BOResponse" value="callresponse" action="set" />
</response>
</call>
<sync name='Esperar Respuesta WiFIS' calls='Enviar WiFIS' timeout='900' allowresync='true' type='all' xpos='200' ypos='1200' />
<code name='Copiar Respuesta BO' xpos='200' ypos='1300' >
<annotation><![CDATA[Copiar respuesta BO para devolverla como resultado de este proceso.]]]]><![CDATA[></annotation>
<![CDATA[ $$$TRACE("Copiar Respuesta WiFIS BO")
 if $isobject(context.BOResponse),$classname(context.BOResponse)="WiFIS.V21.WSC.s1.WSResposta" {
   for i=1:1:context.BOResponse.LlistaMissatges.Count() {
     set tError=##class(WiFIS.V21.BS.s1.WSMissatge).%New()
     set tError.codi=context.BOResponse.LlistaMissatges.GetAt(i).codi
     set tError.descripcio=context.BOResponse.LlistaMissatges.GetAt(i).descripcio
     do response.LlistaMissatges.Insert(tError)
   }
 } else {
   if $isobject(context.BOResponse) {
     $$$LOGWARNING("recibido un "_$classname(context.BOResponse)_" en lugar de WSResposta como indica WiFIS V153")
     set response = context.BOResponse
   } else {
     $$$LOGWARNING("no se ha recibido un objeto válido como respuesta")
   }
 }]]]]><![CDATA[>
</code>
<faulthandlers>
<catchall xpos='200' ypos='1400' xend='200' yend='550' >
<trace name='Catch' value='"Error en WiFIS Router V153"' xpos='200' ypos='250' />
<alert name='alert' value='"Catch!: "_$system.Status.GetOneErrorText(..%Context.%LastError)' xpos='200' ypos='350' />
<code name='Gestion de Error' xpos='200' ypos='450' >
<annotation><![CDATA[Añade info de Error a mensaje de Respuesta]]]]><![CDATA[></annotation>
<![CDATA[ if ($$$ISERR(..%Context.%LastError)) {
   // copiar info de error al response
   set tError=##class(WiFIS.V21.BS.s1.WSMissatge).%New()
   set tError.codi="WIFIS_INVALID"
   set tError.descripcio=$system.Status.GetOneErrorText(..%Context.%LastError)
   do response.LlistaMissatges.Insert(tError)
 }]]]]><![CDATA[>
</code>
</catchall>
</faulthandlers>
</scope>
</sequence>
</process>
]]></Data>
</XData>

<Parameter name="SrcVer">
<Description>
Location and Revision of this file in Perforce (Auto-updating)</Description>
<Default>$Id: //custom_ccrs/_common/tools/Iberia/WiFIS/latest/cls/WiFIS/V21/BP/Router.xml#1 $</Default>
</Parameter>

<Property name="TargetConfigName">
<Description>
Nombre de configuración de destino. Si se configura, todos los mensajes se enviarán a este destino siempre (no se calculará a qué destino hay que enviarlo en función del contenido).</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="500"/>
</Property>

<Parameter name="SETTINGS">
<Default><![CDATA[TargetConfigName:Basic:selector?context={Ens.ContextSearch/ProductionItems?targets=1&productionName=@productionId},-ThrottleDelay,ReplyCodeActions,RetryInterval,AlertRetryGracePeriod:Alerting,FailureTimeout,QueueCountAlert:Alerting,QueueWaitAlert:Alerting]]></Default>
</Parameter>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DefaultData>RouterDefaultData</DefaultData>
<Data name="RouterDefaultData">
<Subscript>"Router"</Subscript>
<Value name="1">
<Value>TargetConfigName</Value>
</Value>
</Data>
</Storage>
</Class>
</Export>
